name: Deploy to Production

# è§¦å‘æ¡ä»¶
on:
  # æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨éƒ¨ç½²
  push:
    branches:
      - main

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘éƒ¨ç½²
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          command_timeout: 30m
          script: |
            echo "=========================================="
            echo "å¼€å§‹éƒ¨ç½² tp-edit-nest åº”ç”¨"
            echo "=========================================="

            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd ${{ secrets.DEPLOY_PATH }}

            # æ˜¾ç¤ºå½“å‰ç‰ˆæœ¬
            echo "å½“å‰ç‰ˆæœ¬:"
            git log -1 --oneline

            # æ‹‰å–æœ€æ–°ä»£ç 
            echo ""
            echo "æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin
            git pull origin main

            # æ˜¾ç¤ºæ–°ç‰ˆæœ¬
            echo ""
            echo "æ›´æ–°åç‰ˆæœ¬:"
            git log -1 --oneline

            # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
            echo ""
            echo "æ‰§è¡Œéƒ¨ç½²è„šæœ¬..."
            chmod +x deploy.sh
            ./deploy.sh

            # å¥åº·æ£€æŸ¥
            echo ""
            echo "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            sleep 5
            if curl -f http://localhost:3005/health > /dev/null 2>&1; then
              echo "âœ“ å¥åº·æ£€æŸ¥é€šè¿‡"
            else
              echo "âœ— å¥åº·æ£€æŸ¥å¤±è´¥"
              exit 1
            fi

            echo ""
            echo "=========================================="
            echo "éƒ¨ç½²å®Œæˆï¼"
            echo "=========================================="

      - name: Deployment Status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—"
          fi
