name: Deploy to Production

# è§¦å‘æ¡ä»¶
on:
  # æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨éƒ¨ç½²
  push:
    branches:
      - main

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘éƒ¨ç½²
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Secrets
        run: |
          echo "æ£€æŸ¥å¿…éœ€çš„ GitHub Secrets..."
          if [ -z "${{ secrets.SSH_HOST }}" ]; then
            echo "âŒ é”™è¯¯: SSH_HOST æœªé…ç½®"
            echo "è¯·åœ¨ GitHub ä»“åº“ Settings > Secrets and variables > Actions ä¸­é…ç½® SSH_HOST"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_USER }}" ]; then
            echo "âŒ é”™è¯¯: SSH_USER æœªé…ç½®"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ é”™è¯¯: SSH_PRIVATE_KEY æœªé…ç½®"
            exit 1
          fi
          if [ -z "${{ secrets.DEPLOY_PATH }}" ]; then
            echo "âŒ é”™è¯¯: DEPLOY_PATH æœªé…ç½®"
            exit 1
          fi

          # éªŒè¯ç§é’¥æ ¼å¼
          PRIVATE_KEY="${{ secrets.SSH_PRIVATE_KEY }}"
          if [[ ! "$PRIVATE_KEY" =~ "BEGIN" ]] || [[ ! "$PRIVATE_KEY" =~ "END" ]]; then
            echo "âš ï¸  è­¦å‘Š: SSH_PRIVATE_KEY å¯èƒ½æ ¼å¼ä¸æ­£ç¡®"
            echo "ç§é’¥åº”è¯¥åŒ…å« -----BEGIN OPENSSH PRIVATE KEY----- å’Œ -----END OPENSSH PRIVATE KEY-----"
            echo "è¯·å‚è€ƒ .github/SSH_TROUBLESHOOTING.md è¿›è¡Œæ’æŸ¥"
          fi

          echo "âœ… æ‰€æœ‰å¿…éœ€çš„ Secrets å·²é…ç½®"
          echo "SSH_HOST: ${{ secrets.SSH_HOST }}"
          echo "SSH_USER: ${{ secrets.SSH_USER }}"
          echo "SSH_PORT: ${{ secrets.SSH_PORT || '22' }}"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          command_timeout: 30m
          debug: true
          script: |
            echo "=========================================="
            echo "å¼€å§‹éƒ¨ç½² tp-edit-nest åº”ç”¨"
            echo "=========================================="

            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd ${{ secrets.DEPLOY_PATH }}

            # æ˜¾ç¤ºå½“å‰ç‰ˆæœ¬
            echo "å½“å‰ç‰ˆæœ¬:"
            git log -1 --oneline

            # æ‹‰å–æœ€æ–°ä»£ç 
            echo ""
            echo "æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin
            git pull origin main

            # æ˜¾ç¤ºæ–°ç‰ˆæœ¬
            echo ""
            echo "æ›´æ–°åç‰ˆæœ¬:"
            git log -1 --oneline

            # ============================================
            # æ¸…ç† Docker èµ„æºä»¥é‡Šæ”¾ç£ç›˜ç©ºé—´
            # ============================================
            echo ""
            echo "=========================================="
            echo "æ¸…ç† Docker èµ„æºä»¥é‡Šæ”¾ç£ç›˜ç©ºé—´"
            echo "=========================================="

            # æ˜¾ç¤ºæ¸…ç†å‰çš„ç£ç›˜ä½¿ç”¨æƒ…å†µ
            echo ""
            echo "æ¸…ç†å‰ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
            df -h / | tail -1
            echo ""
            echo "æ¸…ç†å‰ Docker ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
            docker system df || echo "æ— æ³•è·å– Docker ç£ç›˜ä½¿ç”¨æƒ…å†µ"

            # åœæ­¢æ‰€æœ‰è¿è¡Œä¸­çš„å®¹å™¨ï¼ˆé™¤äº†å½“å‰éƒ¨ç½²éœ€è¦çš„ï¼‰
            echo ""
            echo "åœæ­¢æœªä½¿ç”¨çš„å®¹å™¨..."
            docker ps -q | xargs -r docker stop 2>/dev/null || true

            # åˆ é™¤æ‰€æœ‰åœæ­¢çš„å®¹å™¨
            echo "åˆ é™¤åœæ­¢çš„å®¹å™¨..."
            docker container prune -f || true

            # åˆ é™¤æœªä½¿ç”¨çš„é•œåƒ
            echo "åˆ é™¤æœªä½¿ç”¨çš„é•œåƒ..."
            docker image prune -af || true

            # åˆ é™¤æœªä½¿ç”¨çš„å·ï¼ˆè°¨æ…ï¼šå¯èƒ½ä¼šåˆ é™¤æ•°æ®ï¼‰
            echo "åˆ é™¤æœªä½¿ç”¨çš„å·..."
            docker volume prune -f || true

            # åˆ é™¤æœªä½¿ç”¨çš„ç½‘ç»œ
            echo "åˆ é™¤æœªä½¿ç”¨çš„ç½‘ç»œ..."
            docker network prune -f || true

            # æ¸…ç†æ„å»ºç¼“å­˜
            echo "æ¸…ç†æ„å»ºç¼“å­˜..."
            docker builder prune -af || true

            # å…¨é¢æ¸…ç†ï¼ˆåŒ…æ‹¬æœªä½¿ç”¨çš„æ•°æ®ï¼‰
            echo "æ‰§è¡Œå…¨é¢æ¸…ç†..."
            docker system prune -af --volumes || true

            # æ˜¾ç¤ºæ¸…ç†åçš„ç£ç›˜ä½¿ç”¨æƒ…å†µ
            echo ""
            echo "æ¸…ç†åç£ç›˜ä½¿ç”¨æƒ…å†µ:"
            df -h / | tail -1
            echo ""
            echo "æ¸…ç†å Docker ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
            docker system df || echo "æ— æ³•è·å– Docker ç£ç›˜ä½¿ç”¨æƒ…å†µ"
            echo ""

            # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
            echo ""
            echo "æ‰§è¡Œéƒ¨ç½²è„šæœ¬..."
            chmod +x deploy.sh
            ./deploy.sh

            # å¥åº·æ£€æŸ¥ï¼ˆdeploy.sh å·²ç»åŒ…å«å¥åº·æ£€æŸ¥ï¼Œè¿™é‡Œä½œä¸ºäºŒæ¬¡éªŒè¯ï¼‰
            echo ""
            echo "æ‰§è¡Œæœ€ç»ˆå¥åº·æ£€æŸ¥..."
            sleep 5
            if curl -f http://localhost:3005/api/health > /dev/null 2>&1; then
              echo "âœ“ å¥åº·æ£€æŸ¥é€šè¿‡"
            else
              echo "âœ— å¥åº·æ£€æŸ¥å¤±è´¥"
              echo "æŸ¥çœ‹åº”ç”¨æ—¥å¿—:"
              docker compose -f docker-compose.prod.yaml logs --tail=50 app || docker-compose -f docker-compose.prod.yaml logs --tail=50 app
              exit 1
            fi

            echo ""
            echo "=========================================="
            echo "éƒ¨ç½²å®Œæˆï¼"
            echo "=========================================="

      - name: Deployment Status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—"
          fi
